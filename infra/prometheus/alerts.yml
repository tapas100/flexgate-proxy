# FlexGate Prometheus Alert Rulesgroups:

# Configure these alerts in your Prometheus instance  - name: proxy_alerts

    interval: 30s

groups:    rules:

  - name: flexgate_availability      # Critical alerts

    interval: 30s      - alert: ProxyDown

    rules:        expr: up{job="proxy-server"} == 0

      # High Error Rate Alert        for: 1m

      - alert: HighErrorRate        labels:

        expr: |          severity: critical

          (        annotations:

            sum(rate(flexgate_http_requests_by_status_family_total{status_family=~"4xx|5xx"}[5m]))          summary: "Proxy server is down"

            /          description: "Proxy instance {{ $labels.instance }} is down for more than 1 minute"

            sum(rate(flexgate_http_requests_total[5m]))      

          ) > 0.01      - alert: HighErrorRate

        for: 5m        expr: |

        labels:          (

          severity: warning            sum(rate(http_requests_total{status=~"5.."}[5m]))

          component: api_gateway            /

        annotations:            sum(rate(http_requests_total[5m]))

          summary: "High error rate detected"          ) > 0.05

          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 1%)"        for: 2m

        labels:

      # Critical Error Rate Alert          severity: critical

      - alert: CriticalErrorRate        annotations:

        expr: |          summary: "High error rate detected"

          (          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

            sum(rate(flexgate_http_requests_by_status_family_total{status_family=~"4xx|5xx"}[5m]))      

            /      - alert: UpstreamCompletelyDown

            sum(rate(flexgate_http_requests_total[5m]))        expr: sum(upstream_errors_total{error="connection_refused"}) > 100

          ) > 0.05        for: 1m

        for: 2m        labels:

        labels:          severity: critical

          severity: critical        annotations:

          component: api_gateway          summary: "Upstream is completely unreachable"

        annotations:          description: "Upstream {{ $labels.upstream }} has refused {{ $value }} connections"

          summary: "CRITICAL: Very high error rate"      

          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"      # Warning alerts

      - alert: HighLatency

  - name: flexgate_circuit_breakers        expr: |

    interval: 30s          histogram_quantile(0.99,

    rules:            sum(rate(http_request_duration_ms_bucket[5m])) by (le, route)

      # Circuit Breaker Open Alert          ) > 1000

      - alert: CircuitBreakerOpen        for: 5m

        expr: flexgate_circuit_breaker_state == 2        labels:

        for: 1m          severity: warning

        labels:        annotations:

          severity: warning          summary: "High P99 latency detected"

          component: circuit_breaker          description: "P99 latency for route {{ $labels.route }} is {{ $value }}ms (threshold: 1000ms)"

        annotations:      

          summary: "Circuit breaker open for {{ $labels.upstream }}"      - alert: MemoryUsageHigh

          description: "Circuit breaker for upstream {{ $labels.upstream }} has been open for 1 minute"        expr: |

          (

      # Circuit Breaker Flapping            process_memory_bytes{job="proxy-server"}

      - alert: CircuitBreakerFlapping            /

        expr: |            (512 * 1024 * 1024)

          rate(flexgate_circuit_breaker_transitions_total[10m]) > 0.1          ) > 0.8

        for: 5m        for: 5m

        labels:        labels:

          severity: warning          severity: warning

          component: circuit_breaker        annotations:

        annotations:          summary: "High memory usage"

          summary: "Circuit breaker flapping for {{ $labels.upstream }}"          description: "Memory usage is {{ $value | humanizePercentage }} of limit (threshold: 80%)"

          description: "Circuit breaker for {{ $labels.upstream }} is transitioning frequently"      

      - alert: RateLimitHitFrequently

  - name: flexgate_upstreams        expr: rate(rate_limit_exceeded_total[5m]) > 10

    interval: 30s        for: 5m

    rules:        labels:

      # Upstream Down Alert          severity: warning

      - alert: UpstreamDown        annotations:

        expr: flexgate_upstream_availability == 0          summary: "Frequent rate limit hits"

        for: 1m          description: "Rate limit exceeded {{ $value }} times per second on route {{ $labels.route }}"

        labels:      

          severity: critical      - alert: CircuitBreakerOpen

          component: upstream        expr: circuit_breaker_state{state="open"} == 1

        annotations:        for: 2m

          summary: "Upstream {{ $labels.upstream }} is DOWN"        labels:

          description: "Upstream {{ $labels.upstream }} has been unavailable for 1 minute"          severity: warning

        annotations:

      # High Upstream Error Rate          summary: "Circuit breaker is open"

      - alert: HighUpstreamErrorRate          description: "Circuit breaker for upstream {{ $labels.upstream }} has been open for 2+ minutes"

        expr: |      

          (      - alert: EventLoopLagHigh

            sum(rate(flexgate_upstream_errors_total[5m])) by (upstream)        expr: event_loop_lag_ms > 100

            /        for: 5m

            sum(rate(flexgate_upstream_requests_total[5m])) by (upstream)        labels:

          ) > 0.05          severity: warning

        for: 5m        annotations:

        labels:          summary: "High event loop lag"

          severity: warning          description: "Event loop lag is {{ $value }}ms (threshold: 100ms)"

          component: upstream      

        annotations:      # Info alerts

          summary: "High error rate for upstream {{ $labels.upstream }}"      - alert: ConfigReloaded

          description: "Upstream error rate: {{ $value | humanizePercentage }}"        expr: increase(config_reload_total[1m]) > 0

        labels:

  - name: flexgate_slo          severity: info

    interval: 60s        annotations:

    rules:          summary: "Configuration reloaded"

      # SLO Availability Breach          description: "Proxy configuration was reloaded {{ $value }} times in the last minute"

      - alert: SLOAvailabilityBreach
        expr: flexgate_sli_availability_percent < 99.9
        for: 5m
        labels:
          severity: critical
          component: slo
        annotations:
          summary: "SLO availability breach"
          description: "Availability {{ $value }}% is below SLO target (99.9%)"

      # Error Budget Exhausted
      - alert: ErrorBudgetExhausted
        expr: flexgate_slo_error_budget_percent <= 10
        for: 5m
        labels:
          severity: warning
          component: slo
        annotations:
          summary: "Error budget running low"
          description: "Only {{ $value }}% of error budget remaining"
